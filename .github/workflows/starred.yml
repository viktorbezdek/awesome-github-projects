name: Update starred repositories

on:
  workflow_dispatch:
  schedule:
    # Run daily at 00:30 UTC
    - cron: '30 0 * * *'

# Prevent multiple workflow runs from conflicting
concurrency:
  group: starred-update
  cancel-in-progress: true

permissions:
  contents: write

env:
  STARRED_VERSION: '4.3.0'

jobs:
  awesome-stars:
    name: Update awesome stars list
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install starred
        run: pip install starred==${{ env.STARRED_VERSION }}

      - name: Backup current README
        run: cp README.md README.md.backup || true

      - name: Update starred repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          starred \
            --username viktorbezdek \
            --repository awesome-github-projects \
            --sort \
            --message "update awesome-stars list" \
            --token ${GITHUB_TOKEN}

      - name: Add workflow badge to README
        run: |
          # Add workflow status badge after the title line
          if ! grep -q "workflows/starred.yml/badge.svg" README.md; then
            sed -i '1s|^<!--lint disable|[![Update Stars](https://github.com/viktorbezdek/awesome-github-projects/actions/workflows/starred.yml/badge.svg)](https://github.com/viktorbezdek/awesome-github-projects/actions/workflows/starred.yml)\n\n<!--lint disable|' README.md
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet README.md 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in README.md"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            ADDITIONS=$(diff README.md.backup README.md 2>/dev/null | grep "^>" | wc -l || echo "0")
            DELETIONS=$(diff README.md.backup README.md 2>/dev/null | grep "^<" | wc -l || echo "0")
            echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
            echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
            echo "Changes detected: +$ADDITIONS -$DELETIONS lines"
          fi

      - name: Generate job summary
        if: always()
        run: |
          echo "## Starred Repositories Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
            echo "Changes were detected and committed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Lines added: ~${{ steps.changes.outputs.additions }}" >> $GITHUB_STEP_SUMMARY
            echo "- Lines removed: ~${{ steps.changes.outputs.deletions }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No new stars or changes detected. README is up to date." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -f README.md.backup
